-- ============================================================
-- 🔍 SCRIPT KIỂM TRA & XỬ LÝ USER ĐANG KHÓA BẢNG TRONG ORACLE
-- Tác giả: ChatGPT (GPT-5)
-- Phiên bản: 1.0
-- ============================================================

SET LINESIZE 200
SET PAGESIZE 100
COLUMN username FORMAT A15
COLUMN object_name FORMAT A30
COLUMN machine FORMAT A20
COLUMN sql_text FORMAT A80 WORD_WRAP

PROMPT =====================================================
PROMPT 🔒 DANH SÁCH USER ĐANG KHÓA BẢNG
PROMPT =====================================================

SELECT
    s.sid,
    s.serial#,
    s.username,
    s.machine,
    o.object_name,
    o.object_type,
    l.locked_mode,
    q.sql_text
FROM
    v$locked_object l
    JOIN dba_objects o ON l.object_id = o.object_id
    JOIN v$session s ON l.session_id = s.sid
    LEFT JOIN v$sql q ON s.sql_id = q.sql_id
ORDER BY
    s.username, o.object_name;

PROMPT =====================================================
PROMPT 📖 DIỄN GIẢI CÁC KIỂU LOCK (LOCKED_MODE)
PROMPT =====================================================
PROMPT 1 = Null
PROMPT 2 = Row-S (SS) – Chia sẻ hàng
PROMPT 3 = Row-X (SX) – Khóa hàng độc quyền
PROMPT 4 = Share (S) – Khóa chia sẻ
PROMPT 5 = S/Row-X (SSX) – Chia sẻ / độc quyền hàng
PROMPT 6 = Exclusive (X) – Độc quyền hoàn toàn

PROMPT =====================================================
PROMPT 🚦 CÁC SESSION BỊ CHẶN (WAITING) VÀ ĐANG CHẶN (BLOCKING)
PROMPT =====================================================

SELECT
    s1.username AS waiting_user,
    s1.sid AS waiting_sid,
    s2.username AS blocking_user,
    s2.sid AS blocking_sid,
    o.object_name
FROM
    v$lock l1
    JOIN v$session s1 ON l1.sid = s1.sid
    JOIN v$lock l2 ON l1.id1 = l2.id1 AND l1.id2 = l2.id2
    JOIN v$session s2 ON l2.sid = s2.sid
    JOIN dba_objects o ON l1.id1 = o.object_id
WHERE
    l1.block = 0
    AND l2.block = 1;

PROMPT =====================================================
PROMPT ⚠️  HƯỚNG DẪN KILL SESSION (nếu cần)
PROMPT =====================================================
PROMPT 1️⃣  Ghi lại SID và SERIAL# của session cần kill
PROMPT 2️⃣  Chạy lệnh sau:
PROMPT      ALTER SYSTEM KILL SESSION 'SID,SERIAL#' IMMEDIATE;
PROMPT =====================================================
PROMPT ✅  HOÀN TẤT KIỂM TRA KHÓA BẢNG
PROMPT =====================================================
